name: VNC Access (Stealth)

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  VNC_PASSWORD: VNC@2026!

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Install VNC Server
      shell: pwsh
      run: |
        Write-Host "ğŸ“¦ Installing TightVNC..." -ForegroundColor Cyan
        
        # Download TightVNC
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.84/tightvnc-2.8.84-gpl-setup-64bit.msi" -OutFile "tightvnc.msi"
        
        # Silent install
        Start-Process msiexec.exe -ArgumentList '/i', 'tightvnc.msi', '/quiet', '/norestart', "SET_USEVNCAUTHENTICATION=1", "VALUE_OF_USEVNCAUTHENTICATION=1", "SET_PASSWORD=1", "VALUE_OF_PASSWORD=$env:VNC_PASSWORD", "SET_USECONTROLAUTHENTICATION=1", "VALUE_OF_USECONTROLAUTHENTICATION=1", "SET_CONTROLPASSWORD=1", "VALUE_OF_CONTROLPASSWORD=$env:VNC_PASSWORD" -Wait
        
        Write-Host "â³ Waiting for VNC service to start..." -ForegroundColor Gray
        Start-Sleep -Seconds 10
        
        # Start VNC service
        Start-Service -Name "tvnserver" -ErrorAction SilentlyContinue
        
        Write-Host "âœ… VNC Server installed and running" -ForegroundColor Green
    
    - name: Start Ngrok Tunnel
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Setting up ngrok..." -ForegroundColor Cyan
        
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        Write-Host "ğŸš€ Starting tunnel to VNC (port 5900)..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 5900" -WindowStyle Hidden
        
        Start-Sleep -Seconds 12
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Getting connection details..." -ForegroundColor Cyan
        
        $found = $false
        
        for ($i = 1; $i -le 10; $i++) {
          try {
            $api = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 2 -ErrorAction Stop
            
            if ($api.tunnels -and $api.tunnels.Count -gt 0) {
              $url = $api.tunnels[0].public_url -replace "tcp://", ""
              $parts = $url -split ":"
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘         ğŸ¯ VNC ACCESS READY!              â•‘" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘  Server:   $($parts[0])" -ForegroundColor Cyan
              Write-Host "â•‘  Port:     $($parts[1])" -ForegroundColor Cyan
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘  Password: $env:VNC_PASSWORD" -ForegroundColor Yellow
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“¥ DOWNLOAD VNC VIEWER:" -ForegroundColor White
              Write-Host "   https://www.tightvnc.com/download.php" -ForegroundColor Cyan
              Write-Host "   OR" -ForegroundColor Gray
              Write-Host "   https://www.realvnc.com/download/viewer/" -ForegroundColor Cyan
              Write-Host ""
              Write-Host "ğŸ”Œ TO CONNECT:" -ForegroundColor White
              Write-Host "   1. Open VNC Viewer" -ForegroundColor Gray
              Write-Host "   2. Enter: $($parts[0]):$($parts[1])" -ForegroundColor Gray
              Write-Host "   3. Password: $env:VNC_PASSWORD" -ForegroundColor Gray
              Write-Host ""
              
              $found = $true
              break
            }
          } catch {
            Write-Host "  Attempt $i/10..." -ForegroundColor DarkGray
            Start-Sleep -Seconds 2
          }
        }
        
        if (-not $found) {
          Write-Host ""
          Write-Host "âš ï¸  Manual: https://dashboard.ngrok.com/tunnels/agents" -ForegroundColor Yellow
          Write-Host "Password: $env:VNC_PASSWORD" -ForegroundColor Cyan
        }
    
    - name: Keep Alive
      shell: pwsh
      run: |
        $hours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($hours -le 0) { $hours = 4 }
        
        $endTime = (Get-Date).AddSeconds($hours * 3600)
        
        Write-Host ""
        Write-Host "ğŸ”„ VNC session active for $hours hours" -ForegroundColor Green
        Write-Host "â° Stops at: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host ""
        
        $lastActivity = Get-Date
        
        while ((Get-Date) -lt $endTime) {
          $now = Get-Date
          
          if ($now.Minute % 30 -eq 0 -and $now.Second -lt 30) {
            $left = [math]::Round(($endTime - $now).TotalMinutes)
            Write-Host "[$($now.ToString('HH:mm'))] Active - $left min left" -ForegroundColor DarkGray
          }
          
          if (($now - $lastActivity).TotalSeconds -ge 180) {
            1..50 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            $lastActivity = $now
          }
          
          Start-Sleep -Seconds 30
        }
        
        Write-Host "â±ï¸ Session ended" -ForegroundColor Yellow
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "ğŸ§¹ Cleanup..."
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
        Write-Host "âœ… Done"
