name: SSH + RDP (Advanced)

on: 
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'Duration (hours)'
        required: false
        default: '4'

env:
  NGROK_TOKEN: 2lYIJEGho1ExHGjJGPOnyN8N2Cz_3hv74cinmWnjjYrmQ5PB2
  SSH_PASSWORD: SSH@2026!
  RDP_PASS: P@ssw0rd123!

jobs:
  ssh-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Setup OpenSSH Server
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Installing OpenSSH Server..." -ForegroundColor Cyan
        
        # Install OpenSSH
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        
        # Start and configure SSH service
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        
        # Configure SSH
        $sshdConfig = "C:\ProgramData\ssh\sshd_config"
        (Get-Content $sshdConfig) -replace '#PasswordAuthentication yes', 'PasswordAuthentication yes' | Set-Content $sshdConfig
        (Get-Content $sshdConfig) -replace '#PubkeyAuthentication yes', 'PubkeyAuthentication no' | Set-Content $sshdConfig
        
        # Set password for runneradmin
        $securePass = ConvertTo-SecureString $env:SSH_PASSWORD -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $securePass
        
        # Restart SSH
        Restart-Service sshd
        
        # Allow SSH through firewall
        New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22 -ErrorAction SilentlyContinue
        
        Write-Host "âœ… SSH Server ready" -ForegroundColor Green
    
    - name: Setup RDP
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Setting up RDP..." -ForegroundColor Cyan
        
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        $secureRdpPass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $secureRdpPass
        
        Restart-Service TermService -Force
        Start-Sleep -Seconds 3
        
        Write-Host "âœ… RDP ready" -ForegroundColor Green
    
    - name: Start Ngrok on SSH Port
      shell: pwsh
      run: |
        Write-Host "â¬‡ï¸ Setting up ngrok..." -ForegroundColor Cyan
        
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -Force
        
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_TOKEN
        
        Write-Host "ğŸš€ Starting tunnel to SSH (port 22)..." -ForegroundColor Yellow
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 22" -WindowStyle Hidden
        
        Start-Sleep -Seconds 12
    
    - name: Get Connection Info
      shell: pwsh
      run: |
        Write-Host "ğŸ” Getting SSH tunnel details..." -ForegroundColor Cyan
        
        for ($i = 1; $i -le 10; $i++) {
          try {
            $api = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 2
            
            if ($api.tunnels) {
              $url = $api.tunnels[0].public_url -replace "tcp://", ""
              $parts = $url -split ":"
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘      ğŸ¯ SSH TUNNEL + RDP READY!           â•‘" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•‘  SSH Server: $($parts[0])" -ForegroundColor Cyan
              Write-Host "â•‘  SSH Port:   $($parts[1])" -ForegroundColor Cyan
              Write-Host "â•‘  Username:   runneradmin" -ForegroundColor Yellow
              Write-Host "â•‘  Password:   $env:SSH_PASSWORD" -ForegroundColor Yellow
              Write-Host "â•‘                                            â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
              Write-Host ""
              Write-Host "ğŸ“‹ HOW TO CONNECT:" -ForegroundColor White
              Write-Host ""
              Write-Host "STEP 1: Create SSH Tunnel" -ForegroundColor Yellow
              Write-Host "  ssh -L 13389:localhost:3389 runneradmin@$($parts[0]) -p $($parts[1])" -ForegroundColor Cyan
              Write-Host "  (Enter password: $env:SSH_PASSWORD)" -ForegroundColor Gray
              Write-Host ""
              Write-Host "STEP 2: Connect RDP (in new terminal)" -ForegroundColor Yellow
              Write-Host "  mstsc /v:localhost:13389" -ForegroundColor Cyan
              Write-Host "  (Enter password: $env:RDP_PASS)" -ForegroundColor Gray
              Write-Host ""
              Write-Host "ğŸ’¡ This tunnels RDP through SSH to bypass detection!" -ForegroundColor Green
              Write-Host ""
              
              break
            }
          } catch {
            Start-Sleep -Seconds 2
          }
        }
    
    - name: Keep Alive
      shell: pwsh
      run: |
        $hours = [int]"${{ github.event.inputs.duration_hours }}"
        if ($hours -le 0) { $hours = 4 }
        
        $endTime = (Get-Date).AddSeconds($hours * 3600)
        
        Write-Host "ğŸ”„ SSH+RDP session for $hours hours" -ForegroundColor Green
        Write-Host ""
        
        $lastActivity = Get-Date
        
        while ((Get-Date) -lt $endTime) {
          if (($now - $lastActivity).TotalSeconds -ge 180) {
            1..50 | ForEach-Object { [math]::Sqrt($_) } | Out-Null
            $lastActivity = Get-Date
          }
          Start-Sleep -Seconds 30
        }
    
    - name: Cleanup
      if: always()
      shell: pwsh
      run: |
        Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
